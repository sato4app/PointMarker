<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PointMarker - ポイント図マーキング</title>
    <meta name="description" content="PNG画像のハイキングマップから視覚的にポイントを選択し、座標データをJSONファイルとして出力するWebアプリケーション">

    <!-- Favicon設定（404エラー回避） -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📍</text></svg>">
    <link rel="icon"
        href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=="
        type="image/x-icon">

    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>
    <div class="container">
        <!-- メインコンテンツ -->
        <main class="main-content" data-layout="overlay">
            <!-- 地図表示エリア -->
            <div class="map-container">
                <canvas id="mapCanvas" class="map-canvas"></canvas>
                <div id="imageFilenameDisplay" class="image-filename-display"></div>
            </div>

            <!-- コントロールパネル（オーバーレイ） -->
            <aside class="controls-sidebar">
                <h2>Points/Routes Marker</h2>

                <!-- 画像ファイル入力 -->
                <!-- Stage 1: 画像読み込み -->
                <div id="stage1-container" class="file-input-wrapper">
                    <button type="button" id="stage1ImageBtn" class="file-input-label" title="PNG画像ファイルを選択"
                        aria-label="PNG画像を読み込み">
                        PNG画像を読み込み
                    </button>
                </div>

                <!-- ファイル操作: JSONデータの読み込み・保存 -->
                <div id="file-operations-container" class="file-input-wrapper"
                    style="display: none; align-items: center; gap: 12px;">
                    <button type="button" id="loadJsonBtn" class="file-input-label"
                        style="width: auto; padding: 6px 12px; min-width: 80px;" title="JSONファイルからデータを読み込み"
                        aria-label="読み込み">
                        読み込み
                    </button>
                    <button type="button" id="saveJsonBtn" class="file-input-label"
                        style="width: auto; padding: 6px 12px; min-width: 80px;" title="JSONファイルにデータを保存"
                        aria-label="保存">
                        保存
                    </button>
                </div>

                <!-- 編集モード選択 -->
                <fieldset class="editing-mode-selector">
                    <legend class="sr-only">編集モード選択</legend>
                    <label class="editing-option">
                        <input type="radio" name="editingMode" value="point" checked>
                        <span>ポイント編集</span>
                    </label>
                    <label class="editing-option">
                        <input type="radio" name="editingMode" value="route">
                        <span>ルート編集</span>
                    </label>
                    <label class="editing-option">
                        <input type="radio" name="editingMode" value="spot">
                        <span>スポット編集</span>
                    </label>
                    <label class="editing-option">
                        <input type="radio" name="editingMode" value="area">
                        <span>エリア編集</span>
                    </label>
                </fieldset>

                <!-- ポイント編集パネル -->
                <section class="point-editor" id="pointEditor">
                    <h3>ポイント編集</h3>

                    <div class="point-count" aria-live="polite">
                        ポイント数: <span id="pointCount">0</span>
                    </div>
                </section>

                <!-- ルート編集パネル -->
                <section class="route-editor" id="routeEditor" style="display: none;">
                    <h3>ルート編集</h3>

                    <!-- ルート選択ドロップダウン -->
                    <div class="route-selector">
                        <select id="routeSelectDropdown" aria-label="ルート選択">
                            <option value="">-- ルートを選択 --</option>
                        </select>
                    </div>

                    <!-- ルート操作ボタン -->
                    <div class="route-actions">
                        <button id="addRouteBtn" class="route-action-btn" title="新しいルートを追加">追加</button>
                        <button id="deleteRouteBtn" class="route-action-btn" title="選択中のルートを削除">削除</button>
                    </div>

                    <div class="route-info">
                        <!-- ルート設定 -->
                        <div class="route-points-inputs">
                            <div class="route-point-input">
                                <label for="startPointInput">開始ポイント:</label>
                                <input type="text" id="startPointInput" class="route-point-field" maxlength="4"
                                    aria-describedby="start-point-desc" readonly>
                                <span id="start-point-desc" class="sr-only">既存ポイントのIDを入力</span>
                            </div>
                            <div class="route-point-input">
                                <label for="endPointInput">終了ポイント:</label>
                                <input type="text" id="endPointInput" class="route-point-field" maxlength="4"
                                    aria-describedby="end-point-desc" readonly>
                                <span id="end-point-desc" class="sr-only">既存ポイントのIDを入力</span>
                            </div>
                            <div class="waypoint-count" aria-live="polite">
                                中間点数: <span id="waypointCount">0</span>
                            </div>
                            <div class="popup-visibility-control">
                                <label>
                                    <input type="checkbox" id="showPointIdsCheckbox" checked>
                                    <span>ポイントID表示</span>
                                </label>
                                <label>
                                    <input type="checkbox" id="showSpotNamesCheckbox">
                                    <span>スポット名表示</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- スポット編集パネル -->
                <section class="spot-editor" id="spotEditor" style="display: none;">
                    <h3>スポット編集</h3>

                    <div class="spot-count" aria-live="polite">
                        スポット数: <span id="spotCount">0</span>
                    </div>
                </section>

                <!-- エリア編集パネル -->
                <section class="area-editor" id="areaEditor" style="display: none;">
                    <h3>エリア編集</h3>

                    <!-- エリア選択ドロップダウン -->
                    <div class="area-selector">
                        <select id="areaSelectDropdown" aria-label="エリア選択">
                            <option value="">-- エリアを選択 --</option>
                        </select>
                    </div>



                    <!-- エリア操作ボタン -->
                    <div class="area-actions">
                        <button id="addAreaBtn" class="area-action-btn" title="新しいエリアを追加">追加</button>
                        <button id="deleteAreaBtn" class="area-action-btn" title="選択中のエリアを削除">削除</button>
                    </div>

                    <div class="area-info">
                        <!-- エリア設定 -->
                        <div class="area-points-inputs">
                            <div class="vertex-count" aria-live="polite">
                                頂点数: <span id="vertexCount">0</span>
                            </div>
                            <!-- 必要に応じて表示制御を追加 -->
                        </div>
                    </div>
                </section>

                <!-- ズーム・移動コントロール（最下部） -->
                <div class="navigation">
                    <div class="nav-group">
                        <button type="button" id="settingsBtn" class="nav-btn" title="マーカーのサイズ設定">
                            <img src="icons/mbrisetting3_99522.svg" alt="設定" class="nav-icon">
                        </button>
                        <button type="button" id="panUpBtn" class="nav-btn" title="上に移動" disabled>
                            <img src="icons/arrow-icon-up.svg" alt="上に移動" class="nav-icon">
                        </button>
                        <button type="button" id="resetViewBtn" class="nav-btn" title="表示をリセット" disabled>
                            <img src="icons/reset-icon.svg" alt="リセット" class="nav-icon">
                        </button>
                        <button type="button" id="panLeftBtn" class="nav-btn" title="左に移動" disabled>
                            <img src="icons/arrow-icon-left.svg" alt="左に移動" class="nav-icon">
                        </button>
                        <button type="button" id="panDownBtn" class="nav-btn" title="下に移動" disabled>
                            <img src="icons/arrow-icon-down.svg" alt="下に移動" class="nav-icon">
                        </button>
                        <button type="button" id="panRightBtn" class="nav-btn" title="右に移動" disabled>
                            <img src="icons/arrow-icon-right.svg" alt="右に移動" class="nav-icon">
                        </button>
                    </div>
                    <div class="zoom-group">
                        <button type="button" id="zoomInBtn" class="nav-btn" title="ズームイン" disabled>
                            <img src="icons/zoom-icon-in.svg" alt="ズームイン" class="nav-icon">
                        </button>
                        <button type="button" id="zoomOutBtn" class="nav-btn" title="ズームアウト" disabled>
                            <img src="icons/zoom-icon-out.svg" alt="ズームアウト" class="nav-icon">
                        </button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- 認証状態表示（オーバーレイパネルに追加される） -->
    <div id="authStatus"
        style="display: none; position: fixed; top: 10px; right: 10px; background-color: white; padding: 10px 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10002; font-size: 12px;">
        <div id="authUserInfo">
            <span id="authIcon">🔒</span>
            <span id="authText">認証中...</span>
        </div>
    </div>

    <!-- マーカーサイズ設定パネル -->
    <div id="markerSettingsDialog" class="settings-dialog-overlay" style="display: none;">
        <div class="settings-dialog">
            <div class="settings-dialog-header">
                <span class="settings-dialog-icon">⚙️</span>
                <h3>マーカーサイズ設定／データベース</h3>
            </div>
            <div class="settings-dialog-body">
                <!-- タブ切り替えボタン -->
                <div class="settings-tabs">
                    <button class="settings-tab-btn active" data-tab="marker-settings">マーカーサイズ設定</button>
                    <button class="settings-tab-btn" data-tab="database-settings">データベース</button>
                </div>

                <!-- マーカーサイズ設定タブ -->
                <div id="tab-marker-settings" class="settings-tab-content active">
                    <p class="settings-dialog-message">各マーカーのサイズを指定してください（ピクセル単位）</p>

                    <div class="settings-dialog-controls">
                        <!-- ポイントマーカー -->
                        <div class="settings-control-group">
                            <label for="pointSizeInput">
                                <span class="settings-marker-preview point-marker"></span>
                                <span class="settings-label-text">ポイント:</span>
                            </label>
                            <input type="range" id="pointSizeSlider" class="settings-slider" min="2" max="12" value="6"
                                step="0.5">
                            <input type="number" id="pointSizeInput" class="settings-input" min="2" max="12" value="6"
                                step="0.5">
                            <span class="settings-unit">px</span>
                        </div>

                        <!-- 選択ルート中間点 -->
                        <div class="settings-control-group">
                            <label for="selectedWaypointSizeInput">
                                <span class="settings-marker-preview waypoint-marker selected"></span>
                                <span class="settings-label-text">選択ルート中間点:</span>
                            </label>
                            <input type="range" id="selectedWaypointSizeSlider" class="settings-slider" min="2" max="12"
                                value="6" step="0.5">
                            <input type="number" id="selectedWaypointSizeInput" class="settings-input" min="2" max="12"
                                value="6" step="0.5">
                            <span class="settings-unit">px</span>
                        </div>

                        <!-- 非選択ルート中間点 -->
                        <div class="settings-control-group">
                            <label for="unselectedWaypointSizeInput">
                                <span class="settings-marker-preview waypoint-marker unselected"></span>
                                <span class="settings-label-text">非選択ルート中間点:</span>
                            </label>
                            <input type="range" id="unselectedWaypointSizeSlider" class="settings-slider" min="2"
                                max="12" value="4" step="0.5">
                            <input type="number" id="unselectedWaypointSizeInput" class="settings-input" min="2"
                                max="12" value="4" step="0.5">
                            <span class="settings-unit">px</span>
                        </div>

                        <!-- スポット -->
                        <div class="settings-control-group">
                            <label for="spotSizeInput">
                                <span class="settings-marker-preview spot-marker"></span>
                                <span class="settings-label-text">スポット:</span>
                            </label>
                            <input type="range" id="spotSizeSlider" class="settings-slider" min="4" max="20" value="12"
                                step="0.5">
                            <input type="number" id="spotSizeInput" class="settings-input" min="4" max="20" value="12"
                                step="0.5">
                            <span class="settings-unit">px</span>
                        </div>

                        <!-- エリア頂点 -->
                        <div class="settings-control-group">
                            <label for="areaVertexSizeInput">
                                <span class="settings-marker-preview area-vertex-marker"></span>
                                <span class="settings-label-text">エリア頂点:</span>
                            </label>
                            <input type="range" id="areaVertexSizeSlider" class="settings-slider" min="2" max="12"
                                value="6" step="0.5">
                            <input type="number" id="areaVertexSizeInput" class="settings-input" min="2" max="12"
                                value="6" step="0.5">
                            <span class="settings-unit">px</span>
                        </div>
                    </div>
                </div>

                <!-- データベースタブ -->
                <div id="tab-database-settings" class="settings-tab-content">
                    <p class="settings-dialog-message">Firebaseデータベースとの連携を行います</p>
                    <div class="settings-dialog-controls"
                        style="display: flex; gap: 10px; justify-content: flex-end; padding: 20px 0; flex-direction: row;">
                        <button id="databaseLoadBtn" class="settings-dialog-btn settings-dialog-btn-ok">
                            ☁️ 読み込み
                        </button>
                        <button id="databaseExportBtn" class="settings-dialog-btn settings-dialog-btn-ok">
                            ☁️ 保存
                        </button>
                        <button id="databaseCancelBtn" class="settings-dialog-btn settings-dialog-btn-cancel">
                            キャンセル
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #666; text-align: center;">※ 現在の画像ファイル名に基づくプロジェクトIDで、読み込み・保存されます
                    </p>
                </div>
            </div>
            <div class="settings-dialog-footer">
                <button id="settingsResetBtn" class="settings-dialog-btn settings-dialog-btn-reset">初期値に戻す</button>
                <button id="settingsOkBtn" class="settings-dialog-btn settings-dialog-btn-ok">OK</button>
                <button id="settingsCancelBtn" class="settings-dialog-btn settings-dialog-btn-cancel">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- Firebase設定とモジュールのインポート -->
    <script type="module">
        import { firebaseConfig } from './js/firebase/firebase.config.js';
        import { FirebaseClient } from './js/firebase/FirebaseClient.js';
        import { AuthManager } from './js/firebase/AuthManager.js';
        import { FirestoreDataManager } from './js/firebase/FirestoreDataManager.js';
        import { PointMarkerApp } from './js/app.js';

        // グローバルスコープに配置（app.jsからアクセス可能にする）
        window.firebaseConfig = firebaseConfig;
        window.FirebaseClient = FirebaseClient;
        window.AuthManager = AuthManager;
        window.FirestoreDataManager = FirestoreDataManager;

        // アプリケーション初期化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Firebaseクライアント初期化
                const firebaseClient = new FirebaseClient(firebaseConfig);
                await firebaseClient.initialize();

                // 認証マネージャー初期化
                const authManager = new AuthManager(firebaseClient.getApp());

                // 匿名ログイン
                const authStatusEl = document.getElementById('authStatus');
                const authTextEl = document.getElementById('authText');
                const authIconEl = document.getElementById('authIcon');

                authStatusEl.style.display = 'block';
                authTextEl.textContent = '認証中...';

                await authManager.signInAnonymously();

                authIconEl.textContent = '✅';
                authTextEl.textContent = 'ログイン済み';

                // Firestoreデータマネージャー初期化
                const userId = authManager.getUserId();
                const firestoreManager = new FirestoreDataManager(
                    firebaseClient.getFirestore(),
                    userId
                );

                // グローバルスコープに配置
                window.firebaseClient = firebaseClient;
                window.authManager = authManager;
                window.firestoreManager = firestoreManager;

                // PointMarkerアプリ起動
                const app = new PointMarkerApp();
                window.pointMarkerApp = app;

                // 3秒後に認証状態表示を非表示
                setTimeout(() => {
                    authStatusEl.style.opacity = '0';
                    authStatusEl.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        authStatusEl.style.display = 'none';
                    }, 500);
                }, 3000);

            } catch (error) {
                console.error('アプリケーション初期化エラー:', error);
                const authStatusEl = document.getElementById('authStatus');
                const authTextEl = document.getElementById('authText');
                const authIconEl = document.getElementById('authIcon');

                authStatusEl.style.display = 'block';
                authStatusEl.style.backgroundColor = '#fee';
                authIconEl.textContent = '❌';
                authTextEl.textContent = '初期化失敗: ' + error.message;
            }
        });
    </script>
</body>

</html>