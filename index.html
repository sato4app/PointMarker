<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PointMarker - „Éù„Ç§„É≥„ÉàÂõ≥„Éû„Éº„Ç≠„É≥„Ç∞</title>
    <meta name="description" content="PNGÁîªÂÉè„ÅÆ„Éè„Ç§„Ç≠„É≥„Ç∞„Éû„ÉÉ„Éó„Åã„ÇâË¶ñË¶öÁöÑ„Å´„Éù„Ç§„É≥„Éà„ÇíÈÅ∏Êäû„Åó„ÄÅÂ∫ßÊ®ô„Éá„Éº„Çø„ÇíJSON„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶Âá∫Âäõ„Åô„ÇãWeb„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥">

    <!-- FaviconË®≠ÂÆöÔºà404„Ç®„É©„ÉºÂõûÈÅøÔºâ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìç</text></svg>">
    <link rel="icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" type="image/x-icon">

    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <main class="main-content" data-layout="overlay">
            <!-- Âú∞Âõ≥Ë°®Á§∫„Ç®„É™„Ç¢ -->
            <div class="map-container">
                <canvas id="mapCanvas" class="map-canvas"></canvas>
            </div>
            
            <!-- „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´Ôºà„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºâ -->
            <aside class="controls-sidebar">
                <h2>Points/Routes Marker</h2>

                <!-- ÁîªÂÉè„Éï„Ç°„Ç§„É´ÂÖ•Âäõ -->
                <div class="file-input-wrapper">
                    <button type="button" id="imageInputBtn" class="file-input-label" title="„Éè„Ç§„Ç≠„É≥„Ç∞„Éû„ÉÉ„Éó„ÅÆPNGÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ" aria-label="PNGÁîªÂÉè„ÇíÈÅ∏Êäû">
                        PNGÁîªÂÉè„ÇíÈÅ∏Êäû
                    </button>
                </div>

                <!-- „Éá„Éº„ÇøÊìç‰Ωú„Éú„Çø„É≥ -->
                <div class="firebase-controls" style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" id="loadFromFirebaseBtn" class="btn btn-secondary" disabled
                            aria-label="„Éá„Éº„ÇøË™≠„ÅøËæº„Åø" title="‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô">
                        Ë™≠„ÅøËæº„Åø
                    </button>
                    <button type="button" id="saveToFirebaseBtn" class="btn btn-primary" disabled
                            aria-label="„Éá„Éº„Çø‰øùÂ≠ò" title="ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åô">
                        ‰øùÂ≠ò
                    </button>
                </div>

                <!-- Á∑®ÈõÜ„É¢„Éº„ÉâÈÅ∏Êäû -->
                <fieldset class="editing-mode-selector">
                    <legend class="sr-only">Á∑®ÈõÜ„É¢„Éº„ÉâÈÅ∏Êäû</legend>
                    <label class="editing-option">
                        <input type="radio" name="editingMode" value="point" checked>
                        <span>„Éù„Ç§„É≥„ÉàÁ∑®ÈõÜ</span>
                    </label>
                    <label class="editing-option">
                        <input type="radio" name="editingMode" value="route">
                        <span>„É´„Éº„ÉàÁ∑®ÈõÜ</span>
                    </label>
                    <label class="editing-option">
                        <input type="radio" name="editingMode" value="spot">
                        <span>„Çπ„Éù„ÉÉ„ÉàÁ∑®ÈõÜ</span>
                    </label>
                </fieldset>
                
                <!-- „Éù„Ç§„É≥„ÉàÁ∑®ÈõÜ„Éë„Éç„É´ -->
                <section class="point-editor" id="pointEditor">
                    <h3>„Éù„Ç§„É≥„ÉàÁ∑®ÈõÜ</h3>

                    <div class="point-count" aria-live="polite">
                        „Éù„Ç§„É≥„ÉàÊï∞: <span id="pointCount">0</span>
                    </div>
                </section>
                
                <!-- „É´„Éº„ÉàÁ∑®ÈõÜ„Éë„Éç„É´ -->
                <section class="route-editor" id="routeEditor" style="display: none;">
                    <h3>„É´„Éº„ÉàÁ∑®ÈõÜ</h3>
                    
                    <div class="route-info">
                        <!-- ÈñãÂßã„ÉªÁµÇ‰∫Ü„Éù„Ç§„É≥„ÉàË®≠ÂÆö -->
                        <div class="route-points-inputs">
                            <div class="route-point-input">
                                <label for="startPointInput">ÈñãÂßã„Éù„Ç§„É≥„Éà:</label>
                                <input type="text" id="startPointInput" class="route-point-field" maxlength="4" aria-describedby="start-point-desc">
                                <span id="start-point-desc" class="sr-only">Êó¢Â≠ò„Éù„Ç§„É≥„Éà„ÅÆID„ÇíÂÖ•Âäõ</span>
                            </div>
                            <div class="route-point-input">
                                <label for="endPointInput">ÁµÇ‰∫Ü„Éù„Ç§„É≥„Éà:</label>
                                <input type="text" id="endPointInput" class="route-point-field" maxlength="4" aria-describedby="end-point-desc">
                                <span id="end-point-desc" class="sr-only">Êó¢Â≠ò„Éù„Ç§„É≥„Éà„ÅÆID„ÇíÂÖ•Âäõ</span>
                            </div>
                            
                            <!-- ‰∏≠ÈñìÁÇπÊï∞Ë°®Á§∫ -->
                            <div class="waypoint-count" aria-live="polite">
                                ‰∏≠ÈñìÁÇπÊï∞: <span id="waypointCount">0</span>
                            </div>

                            <!-- „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫Âàá„ÇäÊõø„Åà -->
                            <div class="popup-visibility-control">
                                <label>
                                    <input type="checkbox" id="showPointIdsCheckbox" checked>
                                    <span>„Éù„Ç§„É≥„ÉàIDË°®Á§∫</span>
                                </label>
                                <label>
                                    <input type="checkbox" id="showSpotNamesCheckbox">
                                    <span>„Çπ„Éù„ÉÉ„ÉàÂêçË°®Á§∫</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- „Çπ„Éù„ÉÉ„ÉàÁ∑®ÈõÜ„Éë„Éç„É´ -->
                <section class="spot-editor" id="spotEditor" style="display: none;">
                    <h3>„Çπ„Éù„ÉÉ„ÉàÁ∑®ÈõÜ</h3>

                    <div class="spot-count" aria-live="polite">
                        „Çπ„Éù„ÉÉ„ÉàÊï∞: <span id="spotCount">0</span>
                    </div>
                </section>

                <!-- „Ç∫„Éº„É†„ÉªÁßªÂãï„Ç≥„É≥„Éà„É≠„Éº„É´ÔºàÊúÄ‰∏ãÈÉ®Ôºâ -->
                <div class="navigation">
                    <div class="nav-group">
                        <div></div>
                        <button type="button" id="panUpBtn" class="nav-btn" title="‰∏ä„Å´ÁßªÂãï" disabled>
                            <img src="icons/arrow-icon-up.svg" alt="‰∏ä„Å´ÁßªÂãï" class="nav-icon">
                        </button>
                        <button type="button" id="resetViewBtn" class="nav-btn" title="Ë°®Á§∫„Çí„É™„Çª„ÉÉ„Éà" disabled>
                            <img src="icons/reset-icon.svg" alt="„É™„Çª„ÉÉ„Éà" class="nav-icon">
                        </button>
                        <button type="button" id="panLeftBtn" class="nav-btn" title="Â∑¶„Å´ÁßªÂãï" disabled>
                            <img src="icons/arrow-icon-left.svg" alt="Â∑¶„Å´ÁßªÂãï" class="nav-icon">
                        </button>
                        <button type="button" id="panDownBtn" class="nav-btn" title="‰∏ã„Å´ÁßªÂãï" disabled>
                            <img src="icons/arrow-icon-down.svg" alt="‰∏ã„Å´ÁßªÂãï" class="nav-icon">
                        </button>
                        <button type="button" id="panRightBtn" class="nav-btn" title="Âè≥„Å´ÁßªÂãï" disabled>
                            <img src="icons/arrow-icon-right.svg" alt="Âè≥„Å´ÁßªÂãï" class="nav-icon">
                        </button>
                    </div>
                    <div class="zoom-group">
                        <button type="button" id="zoomInBtn" class="nav-btn" title="„Ç∫„Éº„É†„Ç§„É≥" disabled>
                            <img src="icons/zoom-icon-in.svg" alt="„Ç∫„Éº„É†„Ç§„É≥" class="nav-icon">
                        </button>
                        <button type="button" id="zoomOutBtn" class="nav-btn" title="„Ç∫„Éº„É†„Ç¢„Ç¶„Éà" disabled>
                            <img src="icons/zoom-icon-out.svg" alt="„Ç∫„Éº„É†„Ç¢„Ç¶„Éà" class="nav-icon">
                        </button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Ë™çË®ºÁä∂ÊÖãË°®Á§∫Ôºà„Ç™„Éº„Éê„Éº„É¨„Ç§„Éë„Éç„É´„Å´ËøΩÂä†„Åï„Çå„ÇãÔºâ -->
    <div id="authStatus" style="display: none; position: fixed; top: 10px; right: 10px; background-color: white; padding: 10px 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10002; font-size: 12px;">
        <div id="authUserInfo">
            <span id="authIcon">üîí</span>
            <span id="authText">Ë™çË®º‰∏≠...</span>
        </div>
    </div>

    <!-- FirebaseË®≠ÂÆö„Å®„É¢„Ç∏„É•„Éº„É´„ÅÆ„Ç§„É≥„Éù„Éº„Éà -->
    <script type="module">
        import { firebaseConfig } from './js/firebase/firebase.config.js';
        import { FirebaseClient } from './js/firebase/FirebaseClient.js';
        import { AuthManager } from './js/firebase/AuthManager.js';
        import { FirestoreDataManager } from './js/firebase/FirestoreDataManager.js';
        import { PointMarkerApp } from './js/app.js';

        // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆÔºàapp.js„Åã„Çâ„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Å´„Åô„ÇãÔºâ
        window.firebaseConfig = firebaseConfig;
        window.FirebaseClient = FirebaseClient;
        window.AuthManager = AuthManager;
        window.FirestoreDataManager = FirestoreDataManager;

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Firebase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂàùÊúüÂåñ
                const firebaseClient = new FirebaseClient(firebaseConfig);
                await firebaseClient.initialize();

                // Ë™çË®º„Éû„Éç„Éº„Ç∏„É£„ÉºÂàùÊúüÂåñ
                const authManager = new AuthManager(firebaseClient.getApp());

                // ÂåøÂêç„É≠„Ç∞„Ç§„É≥
                const authStatusEl = document.getElementById('authStatus');
                const authTextEl = document.getElementById('authText');
                const authIconEl = document.getElementById('authIcon');

                authStatusEl.style.display = 'block';
                authTextEl.textContent = 'Ë™çË®º‰∏≠...';

                await authManager.signInAnonymously();

                authIconEl.textContent = '‚úÖ';
                authTextEl.textContent = '„É≠„Ç∞„Ç§„É≥Ê∏à„Åø';

                // Firestore„Éá„Éº„Çø„Éû„Éç„Éº„Ç∏„É£„ÉºÂàùÊúüÂåñ
                const userId = authManager.getUserId();
                const firestoreManager = new FirestoreDataManager(
                    firebaseClient.getFirestore(),
                    userId
                );

                // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÈÖçÁΩÆ
                window.firebaseClient = firebaseClient;
                window.authManager = authManager;
                window.firestoreManager = firestoreManager;

                // PointMarker„Ç¢„Éó„É™Ëµ∑Âãï
                const app = new PointMarkerApp();
                window.pointMarkerApp = app;

                // 3ÁßíÂæå„Å´Ë™çË®ºÁä∂ÊÖãË°®Á§∫„ÇíÈùûË°®Á§∫
                setTimeout(() => {
                    authStatusEl.style.opacity = '0';
                    authStatusEl.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        authStatusEl.style.display = 'none';
                    }, 500);
                }, 3000);

            } catch (error) {
                console.error('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                const authStatusEl = document.getElementById('authStatus');
                const authTextEl = document.getElementById('authText');
                const authIconEl = document.getElementById('authIcon');

                authStatusEl.style.display = 'block';
                authStatusEl.style.backgroundColor = '#fee';
                authIconEl.textContent = '‚ùå';
                authTextEl.textContent = 'ÂàùÊúüÂåñÂ§±Êïó: ' + error.message;
            }
        });
    </script>
</body>
</html>