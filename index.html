<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PointMarker - ãƒã‚¤ãƒ³ãƒˆå›³ãƒãƒ¼ã‚­ãƒ³ã‚°</title>
    <meta name="description" content="PNGç”»åƒã®ãƒã‚¤ã‚­ãƒ³ã‚°ãƒãƒƒãƒ—ã‹ã‚‰è¦–è¦šçš„ã«ãƒã‚¤ãƒ³ãƒˆã‚’é¸æŠã—ã€åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³">

    <!-- Faviconè¨­å®šï¼ˆ404ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    <link rel="icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" type="image/x-icon">

    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-content" data-layout="overlay">
            <!-- åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="map-container">
                <canvas id="mapCanvas" class="map-canvas"></canvas>
            </div>
            
            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ -->
            <aside class="controls-sidebar">
                <h2>Points/Routes Marker</h2>

                <!-- ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
                <div class="file-input-wrapper">
                    <button type="button" id="imageInputBtn" class="file-input-label" title="ãƒã‚¤ã‚­ãƒ³ã‚°ãƒãƒƒãƒ—ã®PNGç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„" aria-label="PNGç”»åƒã‚’é¸æŠ">
                        PNGç”»åƒã‚’é¸æŠ
                    </button>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒœã‚¿ãƒ³ -->
                <div class="firebase-controls" style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" id="loadFromFirebaseBtn" class="btn btn-secondary" disabled
                            aria-label="ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿" title="ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™">
                        èª­ã¿è¾¼ã¿
                    </button>
                    <button type="button" id="saveToFirebaseBtn" class="btn btn-primary" disabled
                            aria-label="ãƒ‡ãƒ¼ã‚¿ä¿å­˜" title="ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™">
                        ä¿å­˜
                    </button>
                </div>

                <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
                <fieldset class="editing-mode-selector">
                    <legend class="sr-only">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é¸æŠ</legend>
                    <label class="editing-option">
                        <input type="radio" name="editingMode" value="point" checked>
                        <span>ãƒã‚¤ãƒ³ãƒˆç·¨é›†</span>
                    </label>
                    <label class="editing-option">
                        <input type="radio" name="editingMode" value="route">
                        <span>ãƒ«ãƒ¼ãƒˆç·¨é›†</span>
                    </label>
                    <label class="editing-option">
                        <input type="radio" name="editingMode" value="spot">
                        <span>ã‚¹ãƒãƒƒãƒˆç·¨é›†</span>
                    </label>
                </fieldset>
                
                <!-- ãƒã‚¤ãƒ³ãƒˆç·¨é›†ãƒ‘ãƒãƒ« -->
                <section class="point-editor" id="pointEditor">
                    <h3>ãƒã‚¤ãƒ³ãƒˆç·¨é›†</h3>

                    <div class="point-count" aria-live="polite">
                        ãƒã‚¤ãƒ³ãƒˆæ•°: <span id="pointCount">0</span>
                    </div>
                </section>
                
                <!-- ãƒ«ãƒ¼ãƒˆç·¨é›†ãƒ‘ãƒãƒ« -->
                <section class="route-editor" id="routeEditor" style="display: none;">
                    <h3>ãƒ«ãƒ¼ãƒˆç·¨é›†</h3>

                    <!-- ãƒ«ãƒ¼ãƒˆé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
                    <div class="route-selector">
                        <select id="routeSelectDropdown" aria-label="ãƒ«ãƒ¼ãƒˆé¸æŠ">
                            <option value="">-- ãƒ«ãƒ¼ãƒˆã‚’é¸æŠ --</option>
                        </select>
                    </div>

                    <!-- ãƒ«ãƒ¼ãƒˆæ“ä½œãƒœã‚¿ãƒ³ -->
                    <div class="route-actions">
                        <button id="addRouteBtn" class="route-action-btn" title="æ–°ã—ã„ãƒ«ãƒ¼ãƒˆã‚’è¿½åŠ ">è¿½åŠ </button>
                        <button id="saveRouteBtn" class="route-action-btn" title="é¸æŠä¸­ã®ãƒ«ãƒ¼ãƒˆã‚’ä¿å­˜">ä¿å­˜</button>
                        <button id="deleteRouteBtn" class="route-action-btn" title="é¸æŠä¸­ã®ãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤">å‰Šé™¤</button>
                    </div>

                    <div class="route-info">
                        <!-- é–‹å§‹ãƒ»çµ‚äº†ãƒã‚¤ãƒ³ãƒˆè¨­å®š -->
                        <div class="route-points-inputs">
                            <div class="route-point-input">
                                <label for="startPointInput">é–‹å§‹ãƒã‚¤ãƒ³ãƒˆ:</label>
                                <input type="text" id="startPointInput" class="route-point-field" maxlength="4" aria-describedby="start-point-desc">
                                <span id="start-point-desc" class="sr-only">æ—¢å­˜ãƒã‚¤ãƒ³ãƒˆã®IDã‚’å…¥åŠ›</span>
                            </div>
                            <div class="route-point-input">
                                <label for="endPointInput">çµ‚äº†ãƒã‚¤ãƒ³ãƒˆ:</label>
                                <input type="text" id="endPointInput" class="route-point-field" maxlength="4" aria-describedby="end-point-desc">
                                <span id="end-point-desc" class="sr-only">æ—¢å­˜ãƒã‚¤ãƒ³ãƒˆã®IDã‚’å…¥åŠ›</span>
                            </div>
                            <!-- ä¸­é–“ç‚¹æ•°è¡¨ç¤º -->
                            <div class="waypoint-count" aria-live="polite">
                                ä¸­é–“ç‚¹æ•°: <span id="waypointCount">0</span>
                            </div>
                        </div>

                        <!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ -->
                        <div class="popup-visibility-control">
                            <label>
                                <input type="checkbox" id="showPointIdsCheckbox" checked>
                                <span>ãƒã‚¤ãƒ³ãƒˆIDè¡¨ç¤º</span>
                            </label>
                            <label>
                                <input type="checkbox" id="showSpotNamesCheckbox">
                                <span>ã‚¹ãƒãƒƒãƒˆåè¡¨ç¤º</span>
                            </label>
                        </div>
                    </div>
                </section>
                
                <!-- ã‚¹ãƒãƒƒãƒˆç·¨é›†ãƒ‘ãƒãƒ« -->
                <section class="spot-editor" id="spotEditor" style="display: none;">
                    <h3>ã‚¹ãƒãƒƒãƒˆç·¨é›†</h3>

                    <div class="spot-count" aria-live="polite">
                        ã‚¹ãƒãƒƒãƒˆæ•°: <span id="spotCount">0</span>
                    </div>
                </section>

                <!-- ã‚ºãƒ¼ãƒ ãƒ»ç§»å‹•ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆæœ€ä¸‹éƒ¨ï¼‰ -->
                <div class="navigation">
                    <div class="nav-group">
                        <div></div>
                        <button type="button" id="panUpBtn" class="nav-btn" title="ä¸Šã«ç§»å‹•" disabled>
                            <img src="icons/arrow-icon-up.svg" alt="ä¸Šã«ç§»å‹•" class="nav-icon">
                        </button>
                        <button type="button" id="resetViewBtn" class="nav-btn" title="è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ" disabled>
                            <img src="icons/reset-icon.svg" alt="ãƒªã‚»ãƒƒãƒˆ" class="nav-icon">
                        </button>
                        <button type="button" id="panLeftBtn" class="nav-btn" title="å·¦ã«ç§»å‹•" disabled>
                            <img src="icons/arrow-icon-left.svg" alt="å·¦ã«ç§»å‹•" class="nav-icon">
                        </button>
                        <button type="button" id="panDownBtn" class="nav-btn" title="ä¸‹ã«ç§»å‹•" disabled>
                            <img src="icons/arrow-icon-down.svg" alt="ä¸‹ã«ç§»å‹•" class="nav-icon">
                        </button>
                        <button type="button" id="panRightBtn" class="nav-btn" title="å³ã«ç§»å‹•" disabled>
                            <img src="icons/arrow-icon-right.svg" alt="å³ã«ç§»å‹•" class="nav-icon">
                        </button>
                    </div>
                    <div class="zoom-group">
                        <button type="button" id="zoomInBtn" class="nav-btn" title="ã‚ºãƒ¼ãƒ ã‚¤ãƒ³" disabled>
                            <img src="icons/zoom-icon-in.svg" alt="ã‚ºãƒ¼ãƒ ã‚¤ãƒ³" class="nav-icon">
                        </button>
                        <button type="button" id="zoomOutBtn" class="nav-btn" title="ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ" disabled>
                            <img src="icons/zoom-icon-out.svg" alt="ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ" class="nav-icon">
                        </button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- èªè¨¼çŠ¶æ…‹è¡¨ç¤ºï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ‘ãƒãƒ«ã«è¿½åŠ ã•ã‚Œã‚‹ï¼‰ -->
    <div id="authStatus" style="display: none; position: fixed; top: 10px; right: 10px; background-color: white; padding: 10px 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10002; font-size: 12px;">
        <div id="authUserInfo">
            <span id="authIcon">ğŸ”’</span>
            <span id="authText">èªè¨¼ä¸­...</span>
        </div>
    </div>

    <!-- Firebaseè¨­å®šã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
    <script type="module">
        import { firebaseConfig } from './js/firebase/firebase.config.js';
        import { FirebaseClient } from './js/firebase/FirebaseClient.js';
        import { AuthManager } from './js/firebase/AuthManager.js';
        import { FirestoreDataManager } from './js/firebase/FirestoreDataManager.js';
        import { PointMarkerApp } from './js/app.js';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é…ç½®ï¼ˆapp.jsã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹ï¼‰
        window.firebaseConfig = firebaseConfig;
        window.FirebaseClient = FirebaseClient;
        window.AuthManager = AuthManager;
        window.FirestoreDataManager = FirestoreDataManager;

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Firebaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
                const firebaseClient = new FirebaseClient(firebaseConfig);
                await firebaseClient.initialize();

                // èªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
                const authManager = new AuthManager(firebaseClient.getApp());

                // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
                const authStatusEl = document.getElementById('authStatus');
                const authTextEl = document.getElementById('authText');
                const authIconEl = document.getElementById('authIcon');

                authStatusEl.style.display = 'block';
                authTextEl.textContent = 'èªè¨¼ä¸­...';

                await authManager.signInAnonymously();

                authIconEl.textContent = 'âœ…';
                authTextEl.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿';

                // Firestoreãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
                const userId = authManager.getUserId();
                const firestoreManager = new FirestoreDataManager(
                    firebaseClient.getFirestore(),
                    userId
                );

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é…ç½®
                window.firebaseClient = firebaseClient;
                window.authManager = authManager;
                window.firestoreManager = firestoreManager;

                // PointMarkerã‚¢ãƒ—ãƒªèµ·å‹•
                const app = new PointMarkerApp();
                window.pointMarkerApp = app;

                // 3ç§’å¾Œã«èªè¨¼çŠ¶æ…‹è¡¨ç¤ºã‚’éè¡¨ç¤º
                setTimeout(() => {
                    authStatusEl.style.opacity = '0';
                    authStatusEl.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        authStatusEl.style.display = 'none';
                    }, 500);
                }, 3000);

            } catch (error) {
                console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                const authStatusEl = document.getElementById('authStatus');
                const authTextEl = document.getElementById('authText');
                const authIconEl = document.getElementById('authIcon');

                authStatusEl.style.display = 'block';
                authStatusEl.style.backgroundColor = '#fee';
                authIconEl.textContent = 'âŒ';
                authTextEl.textContent = 'åˆæœŸåŒ–å¤±æ•—: ' + error.message;
            }
        });
    </script>
</body>
</html>