# PointMarker 利用者の手引
**Version 2025年11月版 v5.3**

## はじめに
PointMarkerは、ハイキングマップの画像からポイント・スポット・ルートをマーキングし、座標データを管理するWebアプリケーションです。登山計画の作成や、実際に歩いたルートの記録、さらに特徴的なスポット情報の管理にも活用できます。

**v5.3の主要改善点**：
- **devicePixelRatio対応**：Windows拡大率125%, 150%などの高DPI環境で正確なマーカー表示
- **オーバーレイレイアウト固定**：フルスクリーン表示で画像表示領域を最大化
- **余白最小化**：画像表示領域の余白を2pxに縮小、より広い表示エリアを確保
- **z-index調整**：コントロールパネルを最前面に配置（ポップアップより上）
- **空白ID削除機能**：重複ID検出後、空白IDで削除可能＋JSON出力時に空白ID自動除外
- **画像左上配置**：PNG画像が左上に配置され、無駄な余白を削減
- ルートポイント入力でのスポット名部分一致機能
- スポット名表示チェックボックスによる表示制御機能
- ポイントID重複チェックのリアルタイム検証
- ルート編集における中間点のドラッグ移動機能
- ポイントID表示チェックボックスによる表示制御機能
- 開始・終了ポイント変更時の中間点クリア確認ダイアログ
- バリデーション機能の統合と強化
- ズーム・パン機能による地図の詳細確認
- より直感的で安定した操作性

すべての処理はブラウザ内で完結し、プライバシーを保護しながら安全にご利用いただけます。

## システム要件

### 対応ブラウザ
- **推奨**：Chrome 86以降（File System Access API対応）、Edge 86以降
- **対応**：Firefox 最新版、Safari 14以降（基本機能利用可能）
- **必要な機能**：HTML5 Canvas、FileReader API、ES6モジュール対応

### 重要：ローカルサーバーの起動
ES6モジュールを使用しているため、**必ずローカルサーバー経由**でアクセスしてください：

```bash
# Python（推奨）
python -m http.server 8000

# または Node.js
npx serve .
```

その後ブラウザで `http://localhost:8000` を開いてください。

**注意**：ファイルを直接ブラウザで開く（file://）とCORSエラーで動作しません。

### ファイル形式
- **入力画像**：PNG形式のみ
- **データ保存**：JSON形式

### ネットワーク
- インターネット接続不要（ローカル処理のみ）
- すべてのデータはローカルファイルに保存
- 外部サーバーへのデータ送信は一切なし

### デバイス対応（新機能）
- **高DPI・拡大率対応**：Windows 125%, 150%などのディスプレイ拡大設定に完全対応
- **devicePixelRatio補正**：どのディスプレイ環境でも一貫したマーカーサイズを維持
- **レスポンシブデザイン**：画面サイズに応じた自動調整

### Favicon対応
- ブラウザタブに📍ピンアイコンが表示されます
- 404エラー（favicon.ico not found）を解消
- PointMarkerの視覚的アイデンティティを強化

## 基本的な使い方

### 1. アプリケーションの起動
1. ローカルサーバーを起動（上記参照）
2. ブラウザで `http://localhost:8000` にアクセス
3. PointMarkerのメイン画面が表示されることを確認
4. ブラウザタブに📍ピンアイコンが表示されることを確認

### 2. 地図画像の読み込み
1. **「PNG画像を選択」**ボタンをクリック
2. ハイキングマップのPNG画像ファイルを選択
3. 画像が自動的にキャンバスに表示されることを確認

**File System Access API対応ブラウザ（Chrome/Edge）の場合**：
- ファイル選択ダイアログが表示されます
- 保存時にファイル名・保存場所を指定可能

**注意事項**：
- PNG形式の画像のみ対応（JPEG、GIF等は非対応）
- 画像は表示領域に合わせて自動スケーリングされます
- アスペクト比は保持されます
- リサイズ処理が最適化され、より滑らかな動作を実現
- **余白最小化**：画像表示領域の余白が2pxに縮小され、より広い表示エリアを確保
- **左上配置**：画像が左上に配置され、無駄な余白を削減

### 3. レイアウト（v5.3で固定）
**オーバーレイレイアウト固定**：
- 地図がフルスクリーン表示され、最大限の表示領域を確保
- コントロールパネルが右上に半透明で重ね表示（z-index: 10001で最前面）
- 画像が左上に配置され、下と右の余白も最小化
- モバイル環境や大画面表示時に最適
- **注意**：サイドバーモードは削除されました

### 4. 編集モードの選択
3つの編集モードから用途に応じて選択できます：
- **ポイント編集**：地図上の重要ポイント（山頂、山小屋、分岐点など）を管理
- **ルート編集**：歩行ルートの詳細記録・計画作成
- **スポット編集**：観光スポット、景勝地、特徴的な場所の記録

## 高DPI・拡大率対応（新機能）

### devicePixelRatio補正
Windows 125%, 150%などのディスプレイ拡大設定でも、マーカーが正確なサイズで表示されます：

- **自動補正**：`window.devicePixelRatio`を使用した自動補正
- **一貫した表示**：どのディスプレイ環境でも同じ大きさのマーカー
- **ズーム対応**：ズーム機能との組み合わせでもサイズ維持
- **高精度**：二重補正システム（dpr + canvasScale）による正確な描画

**対応環境**：
- Windows 100%（dpr: 1.0）
- Windows 125%（dpr: 1.25）
- Windows 150%（dpr: 1.5）
- Windows 200%（dpr: 2.0）
- Retina Displayなどの高DPIディスプレイ

**使用例**：
- 拡大率125%のディスプレイでも、マーカーが拡大されずに一定サイズで表示
- ズームイン（5倍）してもマーカーサイズは変わらず、視認性を維持

## ズーム・パン機能

### 地図の拡大・縮小
地図を詳細に確認したいときは、ズーム機能を使用します：
1. **「+」ボタン（ズームイン）**：地図を拡大（0.2倍ずつ）
2. **「-」ボタン（ズームアウト）**：地図を縮小（0.2倍ずつ）
3. **ズーム範囲**：1.0倍（通常表示）～5.0倍（最大拡大）

**使用例**：
- 中間点を正確に配置したい→ズームインで詳細表示
- 全体のルートを確認したい→ズームアウトで広範囲表示

### 地図の移動
拡大した地図の表示位置を移動するには、パン機能を使用します：
1. **上下左右のボタン（↑↓←→）**：表示位置を50ピクセルずつ移動
2. **直感的操作**：矢印方向に地図が移動

**使用例**：
- 画面外のエリアを確認したい→パンボタンで表示位置を調整
- 特定のポイントを画面中央に→上下左右ボタンで微調整

### 初期状態に戻す
ズーム・パン操作を行った後、元の表示に戻したいときは：
1. **「Reset」ボタン**：ワンクリックで初期表示に復帰
2. すべての変換がクリアされ、地図が最初の状態に戻ります

**注意事項**：
- ズーム・パン操作は表示のみを変更します
- ポイント・スポット・ルートのデータには影響しません
- 入力ボックスの位置は自動的に更新されます
- マーカーサイズはズーム倍率に関係なく一定を維持

## ポイント編集機能

### ポイントの配置
1. **「ポイント編集」**モードを選択（デフォルト）
2. 地図上の任意の場所をクリック
3. 赤い円マーカーが表示され、**動的ポップアップ入力ボックス**が自動表示
4. **自動フォーカス**：新規ポイント作成時、カーソルが末尾に自動設定
5. ポイントIDを入力（X-nn形式：例 A-01、J-12）

### ポイントID管理
- **形式**: X-nn（英大文字1桁-数字2桁）例：A-01, B-15, Z-99
- **自動補正**: 統一されたValidatorsクラスによる処理
  - 全角→半角変換、小文字→大文字変換、0埋め処理
- **入力制御**:
  - 入力中（typing）：補正処理なし、リアルタイム表示
  - フォーカス離脱時（blur）：自動補正実行
- **重複チェック**:
  - フォーカス離脱時（blur）に自動的に重複検証
  - 重複が見つかった場合：ピンク背景（#ffebee）+ 赤枠（#f44336）表示
  - エラーメッセージ表示：「ポイントID "X-nn" は既に使用されています」
  - JSON出力時にも重複チェック実行

### ポイントの編集・移動・削除
- **編集**: 既存ポイントクリック→対応する入力フィールドにフォーカス
- **移動**: ドラッグ&ドロップによる位置変更（ポイント編集モードのみ）
  - 統合ドラッグ処理により、より滑らかで安定した移動を実現
  - オブジェクト検出が改善され、正確なドラッグ開始が可能
- **削除**:
  - Escapeキー、または空入力でblur
  - **重複ID検出後の削除（新機能）**：重複IDエラーが表示された際、空白を入力してblur→ポイント自動削除

### ポイント編集時のUI表示制御
- **ポイントIDポップアップ**: 表示・編集可能
- **カーソル表示**: crosshairカーソルで一貫した操作感
- **統一スタイリング**: 統一された関数による視覚的フィードバック

### ポイントID表示の制御
ポイントIDポップアップの表示/非表示を切り替えることができます：
1. **「ポイントIDを表示」チェックボックス**：ルート編集パネル内に配置
2. **チェックオン**：すべてのポイントIDポップアップが表示されます
3. **チェックオフ**：すべてのポイントIDポップアップが非表示になります

**自動制御**：
- ポイント編集モード切り替え時：チェックボックスが自動的にオン（オフの場合のみ）
- ルート編集モード切り替え時：チェックボックスが自動的にオン
- スポット編集モード時：チェックボックスで表示制御可能

**活用例**：
- ルート編集中にポイントIDを確認したい→チェックボックスをオン
- 地図画像を見やすくしたい→チェックボックスをオフ
- スポット編集中にポイントIDを非表示にしたい→チェックボックスをオフ

### 空白ID削除機能（新機能）
重複ID検出時に、不要なポイントを簡単に削除できます：

1. **重複ID検出**：フォーカス離脱時にピンク背景＋赤枠でエラー表示
2. **空白入力**：該当するポイントID入力フィールドで全文字を削除（空白状態にする）
3. **フォーカスを外す（blur）**：入力フィールドから離れる
4. **自動削除**：そのポイントが自動的に削除されます

**活用例**：
- A-01が重複している→不要な方のA-01を空白にしてblur→削除完了
- 誤って配置したポイント→IDを空白にしてblur→即座に削除
- Escapeキー削除と同じ効果を、入力フィールド操作のみで実現

**JSON出力時の空白ID除外**：
- JSON出力時、空白IDのポイントは自動的に除外されます
- JSON読み込み時、空白IDのポイントは自動的にスキップされます
- クリーンなデータ管理を実現

## スポット編集機能

### スポットとは
観光スポット、景勝地、展望台、滝、特徴的な地形など、地図上の「場所」を四角形マーカー（■）で記録する機能です。ポイントがID管理による体系的な地点管理に対し、スポットは名前による直感的な場所管理に適しています。

### スポットの配置
1. **「スポット編集」**モードを選択
2. 地図上の任意の場所をクリック
3. **四角形マーカー（■）**が青色で表示され、**動的スポット名入力ボックス**が自動表示
4. **自動フォーカス**：新規スポット作成時、カーソルが末尾に自動設定
5. スポット名を入力（例：「展望台」「白山神社」「清水の滝」）

### スポット名管理
- **入力制御**: 最大10文字制限、自由な名前設定
- **リアルタイム表示**: 文字入力中の即座反映
- **trim処理**: 空白文字の自動除去
- **フォーマット処理**:
  - 全角→半角変換、小文字→大文字変換
  - **X-nn形式の自動補正なし**（ポイントIDとは異なる処理）
- **統合管理**: SpotManagerクラスによる効率的なデータ管理
- **ルート編集での利用**: 開始・終了ポイント入力欄でスポット名として部分一致検索可能

### スポットの編集・移動・削除
- **編集**: 既存スポット（■）クリック→対応する入力フィールドにフォーカス
- **移動**: 統合ドラッグ処理による位置変更（スポット編集モードのみ）
- **削除**: Escapeキー、または空入力でblur

### スポット編集時のUI表示制御
- **ポイントIDポップアップ**: チェックボックスで表示制御可能
- **スポット入力ボックス**: 表示・編集可能
- **カーソル表示**: crosshairカーソルで統一された操作感

### スポット名表示の制御
スポット名ポップアップの表示/非表示を切り替えることができます：

1. **「スポット名を表示」チェックボックス**：ルート編集パネル内に配置
2. **チェックオン**：すべてのスポット名ポップアップが表示されます
3. **チェックオフ**：すべてのスポット名ポップアップが非表示になります

**自動制御**：
- ポイント編集モード切り替え時：チェックボックスが自動的にオフ
- ルート編集モード切り替え時：チェックボックスが自動的にオフ
- スポット編集モード時：チェックボックスで表示制御可能

**ズーム・パン対応**：
- ズーム・パン操作後も表示状態を維持
- 強調表示（白背景）・エラー表示（ピンク背景）の状態も保持

**活用例**：
- ルート編集中にスポット名を確認したい→チェックボックスをオン
- 地図画像を見やすくしたい→チェックボックスをオフ
- スポットを選択しながらルート作成→チェックボックスをオンで位置確認

### スポットの視覚表示
- **マーカー形状**: 四角形（■）
- **色**: 青色系（#0066ff、ポイントの赤色と明確に区別）
- **サイズ**: ポイントより大きめ（12px、視認性重視）
- **サイズ補正**: devicePixelRatio + canvasScale による二重補正で一定サイズ維持
- **描画処理**: CanvasRenderer.drawSquare()による最適化された描画

### スポット一括操作
- **「スポットをクリア」**: すべてのスポットを即座に削除（赤色ボタン）
- **「スポットをJSON出力」**: スポットデータをJSON形式で保存（緑色ボタン）
- **「スポットのJSON読込」**: 既存スポットJSONからデータ復元

## ルート編集機能

### ルート編集の準備
1. 事前にポイント編集でルートの開始・終了点を配置
2. **「ルート編集」**モードに切り替え
3. **UI制御**：既存ポイント・スポットの編集が自動的に制限されます

### ルート編集時のUI変更
**完全な視覚的制御**：
- **ポイントIDポップアップ**: チェックボックスで表示制御可能（背景灰色）
- **スポット入力ボックス**: 完全に非表示
- **通常ポイント**: 統一スタイル関数による灰色表示
- **開始・終了ポイント**: 完全白背景＋青枠線で強調表示
- **無効化表示**: 全入力フィールドがdisabled状態

### 開始・終了ポイント入力とバリデーション（強化版）
**スポット名部分一致機能**：
開始・終了ポイント入力欄で、スポット名の部分一致検索が可能です：

1. **スポット名を入力**（例：「展望」と入力）
2. **フォーカスを外す（blur時）**に自動的に部分一致検索を実行
3. **検索結果に応じた処理**：
   - **1件のみ該当**：そのスポット名が自動設定され、緑枠表示
   - **複数件該当**：ピンク背景で警告表示（警告ポップアップなし）
   - **該当なし**：ポイントIDとして処理（X-nn形式自動補正）

**使用例**：
- スポット「展望台A」「展望台B」が存在する場合
  - 「展望」と入力→複数件該当でピンク背景エラー
  - 「展望台A」と完全一致で入力→1件該当で自動設定・緑枠表示
- スポット「白山神社」が存在する場合
  - 「白山」と入力→1件のみ該当で自動的に「白山神社」に設定

**統合バリデーション機能**：
1. **スポット名検索**: 部分一致によるスポット名自動設定
2. **形式チェック**: Validatorsクラスによる厳密なX-nn形式検証
3. **存在チェック**: 既存ポイントIDまたはスポット名との照合
   - 存在しない → 統一エラー表示関数による赤枠エラー
   - 詳細ツールチップでエラー理由説明
4. **重複チェック**: 開始・終了ポイント同一値検出
   - 重複時 → **両フィールド同時に赤枠表示**（強化された検証）
   - 統一メッセージによる注意喚起

**統一エラーフィードバック**：
- **複数一致エラー**: ピンク背景 + 「複数のスポット名が該当します: ○○、△△」
- **形式エラー**: ピンク背景 + 「該当するポイントまたはスポットが見つかりません」
- **存在エラー**: 赤枠のみ + 「ポイント「○○」が見つかりません」
- **重複エラー**: 両フィールド赤枠 + 「開始ポイントと終了ポイントに同じIDが設定されています」
- **正常時**: 緑枠表示

### 開始・終了ポイント変更時の中間点クリア
ルートの開始ポイントまたは終了ポイントを変更する際、既存の中間点をどうするか確認できます：

1. **開始ポイントまたは終了ポイントを変更**
2. **中間点が存在する場合**：確認ダイアログが表示されます
   - メッセージ例：「開始ポイントを「A-01」から「B-02」に変更します。既存の中間点（5個）をクリアしますか？」
3. **「はい」を選択**：中間点のみがクリアされます（開始・終了ポイントは保持）
4. **「キャンセル」を選択**：中間点はそのまま維持されます

**活用例**：
- ルート全体を作り直したい→「はい」で中間点をクリア
- 開始・終了ポイントだけ修正したい→「キャンセル」で中間点を保持
- 誤って変更してしまった→「キャンセル」で元に戻す

### ルートの作成手順
1. **開始ポイント**欄に開始点のID（例：A-01）またはスポット名（例：「展望」）を入力
2. **終了ポイント**欄に終了点のID（例：B-05）またはスポット名（例：「神社」）を入力
3. **自動バリデーション**：統合検証システムによる即座の検証
4. **視覚フィードバック**：指定されたポイントが自動的に白背景＋青枠で強調
5. 地図上でルートの中間点をクリックして順次配置
6. 橙色の菱形で中間点が表示され、ルートラインで接続

### 中間点のドラッグ移動
ルート作成後、中間点の位置を微調整できます：

1. **ルート編集モード**であることを確認
2. **橙色の菱形（中間点）**にマウスを近づける（10ピクセル以内）
3. **カーソルがcrosshairに変わる**ことを確認
4. **マウスボタンを押したままドラッグ**：中間点が移動します
5. **マウスボタンを離す**：新しい位置に中間点が固定されます

**重要なポイント**：
- **クリック**：新しい中間点を追加
- **ドラッグ**：既存の中間点を移動
- **ドラッグ中**：中間点数は変化しません
- **移動のみ**：中間点が削除されることはありません

**活用例**：
- ルートを微調整したい→中間点をドラッグ移動
- より正確なルートを描きたい→ズームインしてから細かく調整
- 間違った位置に配置した→すぐにドラッグで修正

**注意事項**：
- 中間点の削除機能は現在ありません（「中間点をクリア」で全削除のみ）
- ドラッグ操作はルート編集モードでのみ有効です

### ルート情報表示
- **中間点数**: 開始・終了ポイント入力エリア内に表示（終了ポイント入力フィールドの直下）
- **リアルタイム更新**: 中間点追加・削除に応じて自動更新

### ルートデータの操作
- **「中間点をクリア」**: 全中間点を削除（開始・終了ポイントは保持）
- **「ルートをクリア」**: 全中間点と開始・終了ポイント設定を削除（赤色ボタン）
- **「ルートをJSON出力」**:
  - 統合検証システムによる総合チェック→エラーがあれば詳細メッセージ表示
  - ルートデータをJSON形式で保存（緑色ボタン）
- **「ルートのJSON読込」**: 既存ルートJSONからデータ復元・UI再構築

## ファイル操作

### 自動ファイル名生成
保存時のファイル名は自動生成されます：
- **ポイント**: `{画像名}_points.json`
- **ルート**: `{画像名}_route_{開始ポイント}_to_{終了ポイント}.json`
- **スポット**: `{画像名}_spots.json`

例：
- `hakusan_points.json`
- `hakusan_route_A-01_to_B-05.json`
- `hakusan_spots.json`

### 高度な保存機能（Chrome/Edge）
**File System Access API**対応ブラウザでは：
- ファイル名・保存場所の任意指定
- 既存ファイルの上書き確認
- より直感的なファイル操作
- FileHandlerクラスによる統合されたファイル処理

**非対応ブラウザ（Firefox/Safari）**：
- 従来のダウンロード機能で保存
- ブラウザのダウンロードフォルダに自動保存

### 読み込み機能
1. 対応するJSONファイルを選択
2. **座標変換**：CoordinateUtilsクラスによる精密な座標変換
3. **UI再構築**：入力ボックス・状態表示も完全復元
4. **空白ID除外**：空白IDのポイントは自動的にスキップ
5. **エラーハンドリング**: 統合されたエラー処理による安全な読み込み

## 画面の見方

### メイン画面の構成（v5.3更新）
- **キャンバス領域**: 地図画像とマーカーの表示（フルスクリーン、左上配置）
- **編集モード選択**: ポイント・ルート・スポット編集の切り替え
- **コントロールパネル**: 各モード専用の操作ボタン群（右上固定、z-index: 10001）
- **動的ポップアップUI**: ポイント・スポット位置に表示される入力ボックス
- **ステータス表示**: ポイント数・中間点数・スポット数のリアルタイム表示
- **ズーム・パンコントロール**: 地図の拡大縮小・移動操作ボタン

### レイアウト（v5.3で固定）
- **オーバーレイモード固定**: 地図がフルスクリーン、コントロールパネルが右上に半透明オーバーレイ
- **余白最小化**: 画像表示領域の余白が2px、キャンバスサイズ `calc(100vw - 4px)` × `calc(100vh - 4px)`
- **画像左上配置**: 画像が左上に配置され、下と右の余白も最小化
- **最前面パネル**: コントロールパネルがポップアップより前面に表示

### マーカーの色分け・視覚表示
- **赤い円**: 配置したポイント（IDラベル付き、6px半径）
- **青い四角形（■）**: 配置したスポット（名前ラベル付き、12pxサイズ）
- **橙色の菱形**: ルートの中間点（ドラッグ移動可能、6pxサイズ）
- **ルートライン**: 開始→中間点→終了を結ぶ連続線
- **サイズ一定**: devicePixelRatio補正により、どの環境でも一定サイズを維持

**編集モード別の表示制御**：
- **ポイント編集**: ポイントIDポップアップ表示（チェックボックスで制御）、スポット入力ボックス非表示
- **ルート編集**: ポイントIDポップアップ表示（チェックボックスで制御、背景灰色）、スポット入力ボックス非表示
- **スポット編集**: ポイントIDポップアップ表示（チェックボックスで制御）、スポット入力ボックス表示

### ボタンの色分け統一
**全編集モード共通**：
- **クリア系**: 赤色（危険操作を表現）
- **JSON出力系**: 緑色（成功・完了を表現）
- **補正系**: 黄色（注意喚起）

この統一された色分けにより、操作の種類が直感的に理解できます。

### レスポンシブ対応
- **オーバーレイレイアウト**: フルスクリーン表示で最大限の表示領域を確保
- **ウィンドウリサイズ**: ResizeHandlerクラスによる最適化されたリサイズ処理
- **高DPI対応**: devicePixelRatio補正による正確な表示

## データ構造

### ポイントJSON形式
```json
{
    "totalPoints": 3,
    "imageReference": "sample.png",
    "imageInfo": {
        "width": 1920,
        "height": 1080
    },
    "points": [
        {
            "index": 1,
            "id": "A-01",
            "imageX": 245,
            "imageY": 387,
            "isMarker": false
        }
    ],
    "exportedAt": "2025-09-14T10:30:00.000Z"
}
```
**注**: 空白IDのポイントは出力されません。

### ルートJSON形式
```json
{
    "routeInfo": {
        "startPoint": "A-01",
        "endPoint": "B-03",
        "waypointCount": 5
    },
    "imageReference": "sample.png",
    "imageInfo": {
        "width": 1920,
        "height": 1080
    },
    "points": [
        {
            "type": "waypoint",
            "index": 1,
            "imageX": 320,
            "imageY": 450
        }
    ],
    "exportedAt": "2025-09-14T10:45:00.000Z"
}
```

### スポットJSON形式
```json
{
    "totalSpots": 2,
    "imageReference": "sample.png",
    "imageInfo": {
        "width": 1920,
        "height": 1080
    },
    "spots": [
        {
            "index": 1,
            "name": "展望台",
            "imageX": 580,
            "imageY": 320
        }
    ],
    "exportedAt": "2025-09-14T11:00:00.000Z"
}
```

## 活用例

### 総合的な登山計画の作成
1. **ポイント編集**：主要ポイント（山頂、山小屋、分岐点等）をX-nn形式で体系管理
2. **スポット編集**：観光スポット（展望台、滝、神社等）を名前で直感管理
3. **ルート編集**：計画ルートを中間点で詳細設定・統合バリデーション確認
4. **ズーム機能活用**：詳細箇所を拡大して正確な位置調整
5. **中間点調整**：ドラッグ移動機能で実際の道に沿ったルート作成
6. **統合管理**：3種類のデータを組み合わせて包括的な情報管理

### 実歩行記録の詳細記録
1. **ポイント記録**：ナビゲーション上重要なポイントを体系的に記録
2. **スポット記録**：実際に立ち寄った観光地・印象的な場所を名前で記録
3. **ルート記録**：実歩行ルートを中間点で精密再現
4. **詳細調整**：ズームイン機能で細かい位置を正確に記録
5. **微調整**：中間点ドラッグ移動で実際の道筋に合わせる
6. **精密調整**：改良されたドラッグ&ドロップ機能で位置を精密調整

### 地域情報の体系的管理
1. **ポイント管理**：管理対象エリアの重要地点をID体系で管理
2. **スポット管理**：観光資源・特徴的な場所を名前で直感的に管理
3. **ルート管理**：推奨ルート・避難ルートを詳細設定
4. **品質管理**：統合バリデーション機能による一貫性確保
5. **視認性向上**：ポイントID表示チェックボックスで必要に応じて表示制御

### チームでの情報共有
1. **標準化**：統一されたフォーマットによるデータ管理
2. **データ交換**：JSON形式によるチーム間データ共有
3. **役割分担**：
   - ポイント：ナビゲーション担当者
   - スポット：観光情報担当者
   - ルート：ルート計画担当者
4. **統合利用**：各担当が作成したデータを統合活用

## よくある質問・トラブルシューティング

### Q: CORSエラーが発生して動作しません
A: **最重要**：必ずローカルサーバー経由でアクセスしてください。
```bash
python -m http.server 8000
# ブラウザで http://localhost:8000 を開く
```
ファイルを直接開く（file://）は動作しません。

### Q: favicon.icoの404エラーが表示されます
A: v5.0以降で解決済みです：
- 📍ピンアイコンが自動的に設定されます
- 404エラーは発生しなくなりました
- ブラウザタブでPointMarkerが識別しやすくなりました

### Q: マーカーが拡大率によって大きさが変わります
A: v5.3で完全に解決されました：
- **devicePixelRatio対応**：Windows拡大率125%, 150%などに自動対応
- **二重補正システム**：dpr + canvasScale補正により一定サイズを維持
- どのディスプレイ環境でも一貫したマーカー表示を実現

### Q: PNG画像の周りに余白が多すぎます
A: v5.3で改善されました：
- **余白最小化**：padding 2px + キャンバスサイズ `calc(100vw - 4px)` × `calc(100vh - 4px)`
- **画像左上配置**：画像が左上に配置され、無駄な余白を削減
- より広い表示エリアを確保

### Q: コントロールパネルがポップアップの下に隠れます
A: v5.3で解決されました：
- **z-index調整**：コントロールパネルのz-indexを10001に引き上げ
- ポップアップ（z-index: 10000）より常に前面に表示
- 操作性が大幅に向上

### Q: 重複したポイントIDを削除したい
A: v5.3の新機能を使用してください：
1. **重複ID検出**：フォーカス離脱時にピンク背景＋赤枠でエラー表示
2. **空白入力**：該当するポイントID入力フィールドで全文字を削除
3. **フォーカスを外す**：入力フィールドから離れる→自動削除

### Q: JSON出力時に空白IDのポイントが含まれます
A: v5.3で自動的に除外されます：
- **JSON出力時**：空白IDのポイントは自動的に除外
- **JSON読み込み時**：空白IDのポイントは自動的にスキップ
- クリーンなデータ管理を実現

### Q: スポット編集時にポイントIDポップアップが表示されます
A: チェックボックスで制御可能です：
- **スポット編集モード**: 「ポイントIDを表示」チェックボックスで表示/非表示を切り替え
- **チェックオフ**: ポイントIDポップアップが非表示
- **チェックオン**: ポイントIDポップアップが表示（必要に応じて）

### Q: ルート編集で開始・終了ポイントにエラーが出ます
A: 統合バリデーション機能による検証結果です：
- **存在エラー**: 指定したポイントIDが存在しない → 先にポイント編集でポイントを作成
- **重複エラー**: 開始・終了ポイントが同じ → 異なるポイントIDを指定
- **形式エラー**: X-nn形式でない → 正しい形式で入力（例：A-01）

### Q: ポイントID名が重複してエラーが出ます
A: JSON出力時に統合検証を実行します：
- エラーメッセージで重複するIDを確認
- 該当するポイントのIDを修正してから再度出力
- 「ポイントID名の補正」で一括整理も可能
- **v5.3新機能**：空白入力でblur→自動削除

### Q: 中間点をドラッグしようとしても新しい中間点が追加されます
A: 中間点の近く（10ピクセル以内）でドラッグを開始してください：
- **正確な位置でクリック**：中間点の菱形マーカーの真上または近く
- **カーソルの確認**：crosshairカーソルに変わることを確認
- **ゆっくりドラッグ**：マウスを動かしすぎないように注意

### Q: 開始ポイントを変更したら中間点が消えました
A: 確認ダイアログで選択した結果です：
- 開始・終了ポイント変更時に確認ダイアログが表示されます
- **「はい」を選択した場合**：中間点がクリアされます
- **中間点を保持したい場合**：「キャンセル」を選択してください
- この機能により誤操作を防止しています

### Q: ドラッグ&ドロップが滑らかでない
A: v5.0以降で大幅に改善されました：
- **統合ドラッグ処理**: DragDropHandlerクラスによる最適化
- **オブジェクト検出改善**: より正確で高速な検出
- **滑らかな移動**: フレームレート向上による快適な操作

### Q: ポイントを移動できません
A: 編集モードを確認してください：
- **ポイント移動**: ポイント編集モードでのみ可能
- **スポット移動**: スポット編集モードでのみ可能
- **中間点移動**: ルート編集モードでのみ可能
- **ルート編集モード**: ポイント・スポット移動は制限されます

### Q: スポットマーカーが星形ではなく四角形です
A: v5.0で仕様変更されました：
- **新形状**: 四角形（■）青色
- **旧形状**: 星形（★）黄色
- **理由**: ポイントとの視認性向上、描画パフォーマンス改善

### Q: 動作が重く感じます
A: v5.0以降でパフォーマンスが大幅改善されました：
- **コード効率化**: 重複処理の削除、統合クラス化
- **描画最適化**: 必要時のみの再描画
- **メモリ管理改善**: 効率的なオブジェクト管理

### Q: JSONファイルが3種類あって混乱します
A: ファイル名で区別してください：
- **`*_points.json`**: ポイントデータ（X-nn形式ID管理）
- **`*_spots.json`**: スポットデータ（名前管理）
- **`*_route_*.json`**: ルートデータ（開始_to_終了形式）
- 各データは独立して管理・読み込み可能

### Q: ズーム・パン操作後、ポイントが画面外に消えました
A: リセット機能を使用してください：
- **「Reset」ボタン**：ワンクリックで初期表示に復帰
- ポイント・スポット・ルートのデータは保持されています
- 表示だけが初期状態に戻ります

## パフォーマンスガイド

### 推奨使用環境
- **ポイント数**: 200個以下で最適性能
- **スポット数**: 100個以下で最適性能
- **ルート中間点**: 500個以下で最適性能
- **画像サイズ**: 4000x4000ピクセル以下を推奨
- **ブラウザ**: Chrome/Edge最新版で最高性能
- **ディスプレイ**: Windows 100%～200%拡大率対応

### 大量データ使用時
- **混在使用**: ポイント・スポット・ルートを同時大量使用時でも安定動作
- **メモリ管理改善**: より効率的なメモリ使用により安定性向上
- **定期保存**: 作業中は各機能で定期的にJSON保存（推奨）
- **ズーム活用**: 大量データ時はズームインで作業領域を限定

### パフォーマンス改善内容（v5.3）
- **統合処理**: 類似機能の統合によりCPU負荷軽減
- **効率化**: リファクタリングによる処理速度向上
- **安定性**: エラーハンドリング改善による安定動作
- **ズーム・パン最適化**: GPU加速による滑らかな表示
- **devicePixelRatio補正**: 高DPI環境でも高速描画

## データバックアップ・管理

### 推奨バックアップ手順
1. **機能別保存**: ポイント・スポット・ルートを個別にJSON保存
2. **統合管理**: 同一地図の全データを同一フォルダで管理
3. **バージョン管理**: 作業節目での複数バージョン保存
4. **自動化**: 統合ファイル処理により効率的なバックアップ

### ファイル管理のコツ
- **命名規則**:
  - `{地図名}_points_{作成日}.json`
  - `{地図名}_spots_{作成日}.json`
  - `{地図名}_route_{開始}to{終了}_{作成日}.json`
- **フォルダ整理**: 地域別・目的別でのフォルダ分類
- **セット管理**: 関連する3種類のJSONファイルをセットで管理

---

## プライバシーとセキュリティ

### データの安全性
- **完全ローカル処理**: すべての処理はブラウザ内で完結
- **外部送信なし**: インターネット接続や外部サーバーへのデータ送信は一切なし
- **ローカル保存のみ**: データはローカルファイルのみに保存
- **個人情報保護**: 個人情報の収集や追跡は一切行いません

### セキュリティ対策
- **ファイル形式制限**: PNG・JSON形式のみ受け入れ、不正ファイル拒否
- **統合検証**: Validatorsクラスによる一貫したセキュリティ対策
- **XSS対策**: 動的コンテンツの適切なエスケープ処理
- **入力検証**: 厳密なバリデーションによる不正データ排除

## 困ったときは

### 基本的なトラブル解決
1. **ブラウザ更新**: Ctrl+F5またはCmd+Rでページ更新
2. **ローカルサーバー確認**: `http://localhost:8000` でアクセスしているか確認
3. **ブラウザ変更**: Chrome/Edgeへの切り替えを推奨
4. **キャッシュクリア**: ブラウザキャッシュをクリアして再読み込み
5. **リセット機能**: ズーム・パン操作が原因の場合はResetボタン使用

### 詳細情報
- 操作方法がわからない場合は、この手引を再度ご確認ください
- 機能の詳細仕様については「funcspec-202511.md」をご参照ください
- 開発者向け情報については「CLAUDE.md」をご参照ください

---

**最終更新**: 2025年11月11日
**バージョン**: 5.3 (2025年11月版)
**更新内容**:
- devicePixelRatio対応（Windows拡大率125%, 150%等への完全対応）
- オーバーレイレイアウト固定（サイドバーモード削除）
- 画像左上配置 + 余白最小化（2px padding、calc(100vw - 4px)キャンバスサイズ）
- z-index調整（コントロールパネル10001、ポップアップより前面）
- 空白ID削除機能（blur時自動削除 + JSON出力/入力時に除外）
- マーカーサイズ補正システム（dpr + canvasScale二重補正）
- FAQ・トラブルシューティングの更新（v5.3対応）
- 活用例の充実化（新機能の具体的な使用シーン）
- 画面の見方の更新（オーバーレイレイアウト固定、余白最小化）
- より初心者に優しい説明と具体例の追加
