# PointMarker 利用者の手引
**Version 2025年9月版**

## はじめに
PointMarkerは、ハイキングマップの画像からポイントやルートをマーキングし、座標データを管理するWebアプリケーションです。登山計画の作成や、実際に歩いたルートの記録に活用できます。すべての処理はブラウザ内で完結し、プライバシーを保護しながら安全にご利用いただけます。

## システム要件

### 対応ブラウザ
- **推奨**：Chrome 86以降（File System Access API対応）、Edge 86以降
- **対応**：Firefox 最新版、Safari 14以降（基本機能利用可能）
- **必要な機能**：HTML5 Canvas、FileReader API、ES6モジュール対応

### 重要：ローカルサーバーの起動
ES6モジュールを使用しているため、**必ずローカルサーバー経由**でアクセスしてください：

```bash
# Python（推奨）
python -m http.server 8000

# または Node.js
npx serve .
```

その後ブラウザで `http://localhost:8000` を開いてください。

**注意**：ファイルを直接ブラウザで開く（file://）とCORSエラーで動作しません。

### ファイル形式
- **入力画像**：PNG形式のみ
- **データ保存**：JSON形式

### ネットワーク
- インターネット接続不要（ローカル処理のみ）
- すべてのデータはローカルファイルに保存
- 外部サーバーへのデータ送信は一切なし

## 基本的な使い方

### 1. アプリケーションの起動
1. ローカルサーバーを起動（上記参照）
2. ブラウザで `http://localhost:8000` にアクセス
3. PointMarkerのメイン画面が表示されることを確認

### 2. 地図画像の読み込み
1. **「PNG画像を選択」**ボタンをクリック
2. ハイキングマップのPNG画像ファイルを選択
3. 画像が自動的にキャンバスに表示されることを確認

**File System Access API対応ブラウザ（Chrome/Edge）の場合**：
- ファイル選択ダイアログが表示されます
- 保存時にファイル名・保存場所を指定可能

**注意事項**：
- PNG形式の画像のみ対応（JPEG、GIF等は非対応）
- 画像は表示領域に合わせて自動スケーリングされます
- アスペクト比は保持されます

### 3. レイアウトの選択
画面上部で2つのレイアウトから選択できます：
- **サイドバー**（推奨）：地図とコントロールパネルが横並び表示
- **オーバーレイ**：コントロールパネルが地図上に半透明で重ね表示

## ポイント編集機能

### ポイントの配置
1. **「ポイント編集」**モードを選択（デフォルト）
2. 地図上の任意の場所をクリック
3. 赤い円マーカーが表示され、**動的ポップアップ入力ボックス**が自動表示
4. **自動フォーカス**：新規ポイント作成時、カーソルが末尾に自動設定
5. ポイントIDを入力（X-nn形式：例 A-01、J-12）

### 新機能：リアルタイム入力表示
- **入力中の即座反映**：文字を入力すると画面にすぐに表示されます
- **insertion point最適化**：カーソルが常に適切な位置に設定されます
- **フォーカス保持**：入力中に他の処理で割り込まれることがありません

### 既存ポイントの編集
- **ポイントクリック**：既存の赤い円をクリックすると対応する入力フィールドにフォーカス
- **カーソル自動配置**：フォーカス時、カーソルが自動的に末尾に移動
- **通常カーソル表示**：ポイント上にマウスを移動しても、カーソルは通常の矢印アイコンのまま表示

### ポイントID管理
- **形式**: X-nn（英大文字1桁-数字2桁）例：A-01, B-15, Z-99
- **自動補正**: 全角→半角変換、小文字→大文字変換、0埋め処理
- **入力制御**: 
  - 入力中（typing）：補正処理なし、リアルタイム表示
  - フォーカス離脱時（blur）：自動補正実行
- **バリデーション**: 
  - リアルタイム形式チェック
  - 不正形式時の視覚的エラーフィードバック（薄いピンク背景）
  - **重複チェック**: JSON出力時に同一ID存在をエラー検出・処理中断

### ポップアップUIの改良
- **統合デザイン**：入力フィールドとコンテナが一体化した洗練されたデザイン
- **単一青色枠線**：2重枠線問題を解決、視覚的にすっきりした表示
- **最小余白設計**：無駄な余白を排除、効率的な画面利用

### ポイントの移動
**ドラッグ&ドロップによるポイント移動**：
1. 配置済みのポイント（赤い円）の上にマウスを移動
2. **通常カーソル維持**：マウスカーソルは通常の矢印アイコンのまま表示
3. ポイントの上でマウスをクリック&ドラッグ
4. **リアルタイム移動**：マウス移動に合わせてポイントが追従
5. 希望の位置まで移動してマウスボタンを離す
6. **自動再配置**：ポイントが新しい位置に移動し、入力ボックスも自動で再配置

**制限事項**：
- ポイント移動は**ポイント編集モードでのみ有効**
- ルート編集モード中は移動できません
- ホバー検出範囲：ポイント中心から8ピクセル以内

### ポイントの削除
- **Escapeキー**: 選択中のポイント削除
- **空入力**: ID入力ボックスを空にしてフォーカスを外すと削除

### 一括操作
- **「ポイントをクリア」**: すべてのポイントを即座に削除（確認なし）
- **「ポイントID名の補正」**: 全ポイントの一括フォーマット＋空ポイント削除
- **「ポイントをJSON出力」**: 
  - **重複ID検証**→エラーがあれば詳細メッセージ表示・処理中断
  - ポイントデータをJSON形式で保存（**緑色**ボタン）
- **「ポイントのJSON読込」**: 既存JSONファイルからポイント復元・UI再構築

## ルート編集機能

### ルート編集の準備
1. 事前にポイント編集でルートの開始・終了点を配置
2. **「ルート編集」**モードに切り替え
3. **UI制御**：既存ポイントの編集が自動的に制限されます

### ルート編集時のUI変更
**完全な視覚的制御**：
- **通常ポイント**: コンテナ・入力フィールド共に灰色（#e0e0e0）統一
- **開始・終了ポイント**: 完全白背景＋青枠線で強調表示
- **隙間なし設計**: 背景色完全統一により視覚的な隙間を排除
- **無効化表示**: 全入力フィールドがdisabled状態、ツールチップで理由説明
- **通常カーソル表示**：ポイント上にマウスを移動しても、カーソルは通常の矢印アイコンのまま表示

### ルートの作成手順
1. **開始ポイント**欄に開始点のID（例：A-01）を入力
   - **リアルタイム入力**：入力中はフォーマット処理なし
   - **blur時補正**：X-nn形式自動補正・存在確認
2. **終了ポイント**欄に終了点のID（例：B-05）を入力
3. **視覚フィードバック**：指定されたポイントが自動的に白背景＋青枠で強調
4. 地図上でルートの中間点をクリックして順次配置
5. 青い小円で中間点が表示され、ルートラインで接続

### データ検証（自動実行）
ルート出力前に以下を自動チェック：
- 開始ポイントが既存ポイントとして存在するか
- 終了ポイントが既存ポイントとして存在するか  
- 中間点が1つ以上配置されているか
- 開始・終了ポイント両方が設定されているか

### ルートデータの操作
- **「ルートをクリア」**: 全中間点と開始・終了ポイント設定を削除（**赤色**ボタン）
- **「ルートをJSON出力」**: 
  - 総合検証→エラーがあれば詳細メッセージ表示
  - ルートデータをJSON形式で保存（**緑色**ボタン）
- **「ルートのJSON読込」**: 既存ルートJSONからデータ復元・UI再構築

## ファイル操作

### 自動ファイル名生成
保存時のファイル名は自動生成されます：
- **ポイント**: `{画像名}_points.json`
- **ルート**: `{画像名}_route_{開始ポイント}_to_{終了ポイント}.json`

例：`hakusan_route_A-01_to_B-05.json`

### 高度な保存機能（Chrome/Edge）
**File System Access API**対応ブラウザでは：
- ファイル名・保存場所の任意指定
- 既存ファイルの上書き確認
- より直感的なファイル操作

**非対応ブラウザ（Firefox/Safari）**：
- 従来のダウンロード機能で保存
- ブラウザのダウンロードフォルダに自動保存

### 読み込み機能
1. 対応するJSONファイルを選択
2. **座標変換**：データが自動的にキャンバスに復元、現在の表示に合わせて座標調整
3. **UI再構築**：入力ボックス・状態表示も完全復元

**注意事項**：
- 読み込み前に対応する地図画像を読み込んでください
- 不正なJSONファイルはエラーメッセージを表示
- ファイル破損時は適切なエラーハンドリング

## 画面の見方

### メイン画面の構成
- **キャンバス領域**: 地図画像とマーカーの表示（crosshairカーソル）
- **コントロールパネル**: 操作ボタンとモード切り替え
- **動的ポップアップUI**: ポイント位置に表示される統合入力ボックス
- **ステータス表示**: ポイント数・中間点数のリアルタイム表示

### マーカーの色分け・視覚表示
- **赤い円**: 配置したポイント（IDラベル付き）
- **青い小円**: ルートの中間点
- **ルートライン**: 開始→中間点→終了を結ぶ連続線

**ルート編集モード時の特別表示**：
- **白背景＋青枠**: 開始・終了ポイントの強調表示
- **灰色統一背景**: 通常ポイントの無効化表示（コンテナ・入力フィールド完全統一）

### マウスカーソルの表示
- **default（通常矢印）**: ポイント上でのホバー時・通常状態を維持
- **crosshair（十字線）**: キャンバス上での新ポイント配置時

**改良点**：以前の版では、ポイント上にマウスを移動すると「十字の先が矢印」のmoveカーソルに変化していましたが、最新版では**通常の矢印カーソルのまま表示**されるよう改良されました。

### ボタンの色分け
**ポイント編集**：
- **ポイントをクリア**: 赤色（危険操作を表現）
- **ポイントID名の補正**: 黄色（注意喚起）
- **ポイントをJSON出力**: 緑色（成功・完了を表現）

**ルート編集**：
- **ルートをクリア**: 赤色（危険操作を表現）
- **ルートをJSON出力**: 緑色（成功・完了を表現）

この統一された色分けにより、操作の種類が直感的に理解できます。

### レスポンシブ対応
- **デスクトップ**: サイドバーレイアウト推奨
- **モバイル（768px以下）**: レイアウトの自動調整
- **ウィンドウリサイズ**: 自動的にキャンバス・座標・UI要素を調整

## 高度な機能

### 座標系管理（自動処理）
アプリケーションは以下の座標系を内部で自動管理：
- **画像座標系**: 元PNG画像の実ピクセル座標（JSON保存・永続化用）
- **キャンバス座標系**: 表示用スケール座標（描画・UI配置用）
- **スクリーン座標系**: ブラウザ内絶対座標（ポップアップ配置用）
- **マウス座標系**: ブラウザイベント座標（入力処理用）

### 動的ポップアップシステム
- **最適自動配置**: ポイント位置に最適な入力ボックス配置
- **画面端考慮**: 画面外に出ない位置自動調整・重なり回避
- **フォーカス管理**: 入力中の再描画回避によるフォーカス完全保持
- **insertion point制御**: カーソル位置の最適化

### パフォーマンス最適化
- **必要時再描画**: Canvas最適化により不要な描画処理を回避
- **座標キャッシュ**: スケール計算結果の再利用
- **イベント効率化**: デバウンス処理によるリサイズ最適化
- **メモリ管理**: DOM要素・イベントリスナーの適切な管理

### アクセシビリティ
- **キーボード操作**: Tab移動、Escape削除対応
- **ARIA属性**: スクリーンリーダー対応・適切なラベリング
- **カラーコントラスト**: WCAG準拠の配色設計
- **フォーカスインジケーター**: 視覚的フォーカス表示

## データ構造

### ポイントJSON形式
```json
{
    "totalPoints": 3,
    "imageReference": "sample.png",
    "imageInfo": {
        "width": 1920,
        "height": 1080
    },
    "points": [
        {
            "index": 1,
            "id": "A-01",
            "imageX": 245,
            "imageY": 387,
            "isMarker": false
        }
    ],
    "exportedAt": "2025-09-01T10:30:00.000Z"
}
```

### ルートJSON形式
```json
{
    "routeInfo": {
        "startPoint": "A-01",
        "endPoint": "B-03",
        "waypointCount": 5
    },
    "imageReference": "sample.png",
    "imageInfo": {
        "width": 1920,
        "height": 1080
    },
    "points": [
        {
            "type": "waypoint",
            "index": 1,
            "imageX": 320,
            "imageY": 450
        }
    ],
    "exportedAt": "2025-09-01T10:45:00.000Z"
}
```

## よくある質問・トラブルシューティング

### Q: CORSエラーが発生して動作しません
A: **最重要**：必ずローカルサーバー経由でアクセスしてください。
```bash
python -m http.server 8000
# ブラウザで http://localhost:8000 を開く
```
ファイルを直接開く（file://）は動作しません。

### Q: 画像が表示されません
A: PNG形式の画像ファイルであることを確認してください。JPEG、GIF等は対応していません。

### Q: 入力した文字がリアルタイムで表示されません
A: 最新版では入力中の即座反映に対応しています。問題が続く場合：
- ブラウザを更新（Ctrl+F5またはCmd+R）
- ローカルサーバーの再起動
- Chrome/Edgeの最新版を推奨

### Q: ポイントID名が重複してエラーが出ます
A: JSON出力時に重複ID検証を実行します：
- エラーメッセージで重複するIDを確認
- 該当するポイントのIDを修正してから再度出力
- 「ポイントID名の補正」で一括整理も可能

### Q: ポイント上でカーソルが十字矢印になってしまいます
A: 最新版では解決済みです：
- ポイント上にマウスを移動しても通常の矢印カーソルを維持
- 以前の版で見られた「十字の先が矢印」は表示されません
- より自然な操作感を提供

### Q: ボタンの色が統一されていません
A: 最新版では統一された色分けに対応：
- **赤色**: クリア操作（危険を表現）
- **緑色**: JSON出力操作（成功・完了を表現）
- **黄色**: 補正操作（注意喚起）
- ポイント編集とルート編集で同系統のボタンが同じ色に統一

### Q: ポップアップに2重の枠が表示されます
A: 最新版では統合デザインにより解決済みです：
- 単一青色枠線のみ表示
- 最小余白設計で無駄なスペースを排除

### Q: ルート編集モードで背景に隙間が見えます
A: 最新版では完全統制により解決済みです：
- コンテナと入力フィールドの背景色完全統一
- 通常ポイント：完全灰色統一
- 開始・終了ポイント：完全白色統一

### Q: ポイントを移動できません
A: 以下を確認してください：
- **モード確認**: ポイント編集モードになっているか（ルート編集モードでは移動不可）
- **位置確認**: ポイント（赤い円）の中心8px以内にマウスカーソルがあるか
- **操作確認**: カーソルは通常の矢印のまま、クリック&ドラッグで移動

### Q: ドラッグ中にポイントが正しく移動しません
A: 
- ポイントの中心部分をクリックしてドラッグしてください
- マウス移動速度を落とすとより正確に操作可能
- 8ピクセル検出範囲内でクリック開始してください

### Q: JSONファイルが読み込めません
A: 以下を確認してください：
- PointMarkerで出力したJSONファイルであること
- ファイルが破損していないこと
- 読み込み前に対応する地図画像を読み込んでいること
- 座標変換処理のため、画像サイズ情報が必要です

### Q: ルートJSON出力でエラーが出ます
A: 自動検証により以下の条件を満たしているか確認：
- **開始・終了ポイント**: 既存ポイントとして存在する
- **中間点**: 1つ以上配置されている
- **設定確認**: 開始・終了ポイント両方が設定されている
- エラーメッセージで具体的な不足項目を確認してください

### Q: File System Access APIが利用できません
A: 
- **Chrome/Edge 86+**: 完全対応、高度な保存機能利用可能
- **Firefox/Safari**: フォールバック動作、ダウンロード機能で代替
- 基本機能はすべてのブラウザで利用可能です

## 活用例

### 登山計画の作成
1. 登山ルートマップのPNG画像を読み込み
2. **体系的ポイント配置**: 主要ポイント（山頂、山小屋、分岐点等）をX-nn形式で配置
3. **精密ルート設定**: 計画ルートを中間点で詳細設定
4. **重複チェック**: JSON出力時の自動検証でID管理品質確保
5. **データ保存**: JSONデータとして保存し、登山当日にモバイルで参照

### 実歩行記録の作成
1. 実際に歩いたルートの地図を読み込み
2. **印象ポイント記録**: 立ち寄ったポイントや印象的な場所を記録
3. **精密位置調整**: **ポイント移動機能**を活用して位置を精密調整
4. **詳細ルート再現**: 実歩行ルートを中間点で精密に再現
5. **記録保存**: 記録として保存し、後日振り返りや共有に活用

### 複数ルートの比較検討
1. **同一地図・複数ルート**: 同一地図で複数のルートパターンを作成
2. **個別保存**: それぞれ別JSONファイルとして保存
3. **比較検討**: 必要に応じて読み込み切り替えで比較検討
4. **最適化**: ドラッグ&ドロップ機能で微調整・最適化

### 地理情報管理
1. **エリア体系化**: 管理対象エリアの地図にポイント情報を体系化
2. **ID統一管理**: X-nn形式による一貫したID管理
3. **重複防止**: 自動重複検証による品質確保
4. **データ連携**: JSON形式による他システムとのデータ連携

### チームでの情報共有
1. **標準化**: 統一されたX-nn形式によるポイント管理
2. **データ交換**: JSON形式によるチーム間データ共有
3. **精密調整**: 各自が必要に応じてポイント位置を微調整
4. **品質管理**: 重複チェック機能による一貫性確保

## パフォーマンスガイド

### 推奨使用環境
- **ポイント数**: 100個以下で最適性能
- **画像サイズ**: 2000x2000ピクセル以下を推奨
- **ブラウザ**: Chrome/Edge最新版で最高性能

### 大量データ使用時
- **数百ポイント**: 動作が重い場合、ブラウザ再起動
- **大容量画像**: メモリ不足時、画像サイズ縮小
- **複雑ルート**: 中間点数百個でも正常動作

### メモリ最適化
- **定期保存**: 作業中は定期的にJSON保存を推奨
- **ブラウザ更新**: 長時間使用後は画面更新を推奨
- **タブ管理**: 他のタブを閉じることでメモリ効率向上

## データバックアップ・管理

### 推奨バックアップ手順
1. **作業節目**: 重要な作業完了時にJSON保存
2. **複数バージョン**: 異なる名前でバージョン管理
3. **定期保存**: 長時間作業では30分ごとに保存推奨

### ファイル管理のコツ
- **命名規則**: `{地図名}_{作成日}_{バージョン}` 形式推奨
- **フォルダ整理**: 地域別・目的別でのフォルダ分類
- **メタデータ**: JSONファイル内のexportedAt情報を活用

---

## プライバシーとセキュリティ

### データの安全性
- **完全ローカル処理**: すべての処理はブラウザ内で完結
- **外部送信なし**: インターネット接続や外部サーバーへのデータ送信は一切なし
- **ローカル保存のみ**: データはローカルファイルのみに保存
- **個人情報保護**: 個人情報の収集や追跡は一切行いません

### セキュリティ対策
- **ファイル形式制限**: PNG・JSON形式のみ受け入れ、不正ファイル拒否
- **入力検証**: 厳密なバリデーションによる不正データ排除
- **XSS対策**: 動的コンテンツの適切なエスケープ処理

## 困ったときは

### 基本的なトラブル解決
1. **ブラウザ更新**: Ctrl+F5またはCmd+Rでページ更新
2. **ローカルサーバー確認**: `http://localhost:8000` でアクセスしているか確認
3. **ブラウザ変更**: Chrome/Edgeへの切り替えを推奨

### 詳細情報
- 操作方法がわからない場合は、この手引を再度ご確認ください
- 機能の詳細仕様については「funcspec.md」をご参照ください

---

**最終更新**: 2025年9月1日  
**バージョン**: 3.1  
**更新内容**: 
- ポイント上マウスホバー時のカーソル表示改善（通常矢印に統一）
- ルート編集ボタンの色分け統一（ルートクリア：赤色、JSON出力：緑色）
- ポイント編集とルート編集のUI統一性向上
- マウスカーソル仕様の詳細説明・FAQ追加
- ボタン色分けに関する説明・FAQ追加
- 操作性向上に関する包括的な情報更新